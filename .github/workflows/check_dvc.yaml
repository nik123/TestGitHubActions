name: Check DVC

on: pull_request

jobs:
  dvcchecker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v2
      - name: "dvc_filelist"
        # Get new and modified DVC files:
        run: |
          base_ref=origin/${{ github.base_ref }}
          filelist=$(git diff --name-only --diff-filter=d $base_ref | sed -n "/\.dvc$/ p")
          echo "New and modified DVC files: $filelist"
          echo "::set-env name=filelist::$filelist"
      - name: "install dvc"
        run: |
          pip install dvc[all]
      - name: "check dvc data"
        # Check if DVC data is pushed to remote
        run: |
          if [ -z "$filelist" ]; then
            echo "There are no changed DVC files"
            exit
          fi

          SSH_DIR="$HOME/.ssh"

          echo "Creating dir $SSH_DIR..."
          mkdir "$SSH_DIR"

          keyfile="$SSH_DIR/dvc_rsa"
          touch "$keyfile"
          echo "${{ secrets.DVCREPO_RSA }}" > "$keyfile"

          CONFIG_FILE="$SSH_DIR/config"
          echo "Creating config file $CONFIG_FILE"
          touch "$CONFIG_FILE"
          cat "Host 104.248.41.64 > "$CONFIG_FILE"
          # define any custom port you want:
          # cat "    Port custom_port" >> "$CONFIG_FILE"
          cat "    User dvcrepo" >> "$CONFIG_FILE"
          cat "    IdentityFile $keyfile" >> "$CONFIG_FILE"

          dvc status -qc "$filelist"
